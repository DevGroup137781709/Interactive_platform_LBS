/**
 * New node file
 */

module.exports = function(req,res){
    return {
        parse:function(callback){
            
            var contentType, boundary, contentLength; 
            var boundaryReg = /^multipart\/form\-data; boundary=(.*)$/i;
            var boundaryEnd;
            if(! /POST/i.test(req.method)){
                callback(new Error("request not have post data"))
            }
            
            //debugger;
            contentType = req.headers["content-type"];
            contentLength = req.headers["content-length"];
            if(contentType == "application/x-www-form-urlencoded"){
                
            }
            
            console.log(req.headers);
            console.log("******************");
            
            if(boundaryReg.test(contentType)){
                
                boundary = "--" + boundaryReg.exec(contentType)[1];
                req.on('readable', function(){
                    var rs = [];
                    req.setEncoding("utf-8");
                    buf = req.read(contentLength);
                    
                    // 判断是否有完整结尾.
                    
//                    if(buf.lastIndexOf();)
                    
                    
                    console.log(buf,"\n ===============\n\n\n");
                    
                    contents = buf.split(boundary);
                    contents.forEach(function(item,index){
                        // find info field
                        var cursor = item.indexOf("\n\n");
                        console.log("##########",index, cursor);
                        console.log(item);
                    });
                });
            }
            
            
            
            return false;
        }
    }
}